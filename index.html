<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Assistente Virtual SEDAP - Resetável</title>
</head>
<body>
  <h1>Assistente Virtual SEDAP</h1>
  <p>O chat zera o histórico automaticamente a cada 10 minutos.</p>

  <!-- Chat SDK Coze -->
  <script src="https://sf-cdn.coze.com/obj/unpkg-va/flow-platform/chat-app-sdk/1.2.0-beta.6/libs/oversea/index.js"></script>
  <script>
    // Configurações fixas
    const PAT = 'pat_nOMe2AdxZGxCYGUrqDJFt65jsuDN3PleNl7H1Pemqr823RkZ413uNqizVN0LQg3M';
    const bot_id = '7570014364363751432';
    const user_id = (localStorage.getItem('cozeUserId') || (() => {
      const uuid = crypto.randomUUID();
      localStorage.setItem('cozeUserId', uuid);
      return uuid;
    })());

    // Widget de chat padrão, retorna conversationId via callback interno
    let conversationId = null;

    function startChat() {
      window._cozeWidget = new CozeWebSDK.WebChatClient({
        config: { bot_id },
        componentProps: { title: 'Assistente SEDAP' },
        auth: { type: 'token', token: PAT },
        user: { id: user_id, name: 'Visitante' },
        hooks: {
          afterCreateConversation: function(data) { 
            if (data && data.id) {
              conversationId = data.id; 
              localStorage.setItem('cozeCurrentConversationId', data.id);
            }
          }
        }
      });
    }
    startChat();

    // Função para limpeza (reset) automática do contexto
    async function clearContext(conversation_id) {
      if (!conversation_id) return;
      try {
        const resp = await fetch(`https://api.coze.com/v1/conversations/${conversation_id}/clear`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + PAT,
            'Content-Type': 'application/json'
          },
          body: '{}'
        });
        const json = await resp.json();
        console.log('Contexto limpo:', json);
      } catch (e) {
        console.error('Falha ao limpar contexto:', e);
      }
    }

    // Reset automático a cada 10 minutos
    setInterval(() => {
      // Tenta obter o conversationId do widget ou do localStorage
      const id = conversationId || localStorage.getItem('cozeCurrentConversationId');
      if (id) clearContext(id);
    }, 10 * 60 * 1000); // 10 minutos

  </script>
</body>
</html>
