<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Assistente SEDAP</title>
</head>
<body>
  <h1>Assistente Virtual SEDAP</h1>
  <p>limpa o contexto a cada 10 minutos automaticamente.</p>

  <!-- Chat SDK Coze (Oversea) -->
  <script src="https://sf-cdn.coze.com/obj/unpkg-va/flow-platform/chat-app-sdk/1.2.0-beta.6/libs/oversea/index.js"></script>

  <script>
    // ===== Configurações fixas =====
    const PAT = 'pat_nOMe2AdxZGxCYGUrqDJFt65jsuDN3PleNl7H1Pemqr823RkZ413uNqizVN0LQg3M'; // coloque seu PAT válido aqui
    const BOT_ID = '7570014364363751432'; // seu bot_id
    const CLEAR_INTERVAL_MIN = 1; // minutos para reset automático

    // Gera/recupera um user_id estável por navegador
    function getUserId() {
      let uid = localStorage.getItem('cozeUserId');
      if (!uid) {
        uid = (crypto.randomUUID && crypto.randomUUID()) || (Math.random().toString(36).slice(2) + Date.now());
        localStorage.setItem('cozeUserId', uid);
      }
      return uid;
    }

    let conversationId = localStorage.getItem('cozeCurrentConversationId') || null;

    // ===== Inicializa o widget com PAT e onRefreshToken =====
    function startChat() {
      window._cozeWidget = new CozeWebSDK.WebChatClient({
        config: { bot_id: BOT_ID },
        componentProps: { title: 'Assistente SEDAP' },
        auth: {
          type: 'token',
          token: localStorage.getItem('COZE_PAT') || PAT,
          onRefreshToken: async () => {
            // Em cenários com PAT, apenas devolva o mesmo token;
            // se um dia trocar o PAT via localStorage, o SDK pegará o novo.
            return localStorage.getItem('COZE_PAT') || PAT;
          }
        },
        user: {
          id: getUserId(),
          name: 'Visitante'
        },
        // Hook para capturar a conversa criada/ativa
        hooks: {
          afterCreateConversation: function (data) {
            if (data && data.id) {
              conversationId = data.id;
              localStorage.setItem('cozeCurrentConversationId', conversationId);
              console.log('Conversation criada/ativa:', conversationId);
            }
          }
        }
      });
    }

    // ===== Chamada de limpeza de contexto (reset) por API =====
    async function clearContext(convId) {
      if (!convId) return;
      try {
        const resp = await fetch(`https://api.coze.com/v1/conversations/${convId}/clear`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + (localStorage.getItem('COZE_PAT') || PAT),
            'Content-Type': 'application/json'
          },
          body: '{}'
        });
        const json = await resp.json();
        console.log('Contexto limpo:', json);
      } catch (e) {
        console.error('Falha ao limpar contexto:', e);
      }
    }

    // ===== Agendamento automático de reset =====
    setInterval(() => {
      const id = conversationId || localStorage.getItem('cozeCurrentConversationId');
      if (id) clearContext(id);
    }, CLEAR_INTERVAL_MIN * 60 * 1000);

    // Opcional: expor uma função manual para reset via console
    window.resetAgora = () => {
      const id = conversationId || localStorage.getItem('cozeCurrentConversationId');
      if (id) clearContext(id);
      else console.warn('Sem conversationId ainda.');
    };

    // Inicia o chat
    startChat();
  </script>
</body>
</html>

