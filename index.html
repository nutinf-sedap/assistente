<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Assistente Virtual - SEDAP (PKCE)</title>
</head>
<body>
  <h1>Assistente Virtual</h1>
  <p>Autorize sua sessão e inicie o chat. Cada navegador/dispositivo terá conversa independente.</p>
  <button id="login-btn">Autorizar com Coze</button>

  <!-- Chat SDK -->
  <script src="https://sf-cdn.coze.com/obj/unpkg-va/flow-platform/chat-app-sdk/1.2.0-beta.6/libs/oversea/index.js"></script>

  <script>
    // Configuração PKCE/Coze
    const CONFIG = {
      clientId: '91667855569600637436985377941744.app.coze',
      redirectUri: 'https://nutinf-sedap.github.io/assistente/',
      authUrl: 'https://www.coze.com/oauth/authorize',
      tokenUrl: 'https://api.coze.com/oauth/token',
      scopes: 'chat createConversation retrieveConversation listConversation createMessage listMessage getMetadata',
      botId: '7570014364363751432'
    };

    // Utilidades
    function b64url(buf) {
      return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+/g, '');
    }
    function getOrCreateUserId() {
      let id = localStorage.getItem('cozeUserId');
      if (!id) { id = crypto.randomUUID(); localStorage.setItem('cozeUserId', id); }
      return id;
    }

    async function generatePKCE() {
      const random = new Uint8Array(32);
      crypto.getRandomValues(random);
      const verifier = b64url(random);
      const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
      const challenge = b64url(digest);
      return { verifier, challenge };
    }

    async function initiateOAuth() {
      const { verifier, challenge } = await generatePKCE();
      const state = crypto.randomUUID();
      localStorage.setItem('coze_state', state);
      localStorage.setItem('coze_verifier', verifier);

      const params = new URLSearchParams({
        client_id: CONFIG.clientId,
        redirect_uri: CONFIG.redirectUri,
        response_type: 'code',
        scope: CONFIG.scopes,
        code_challenge: challenge,
        code_challenge_method: 'S256',
        state
      });
      window.location.href = `${CONFIG.authUrl}?${params.toString()}`;
    }

    async function exchangeCodeForTokenIfPresent() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const state = url.searchParams.get('state');
      if (!code) return;

      const savedState = localStorage.getItem('coze_state');
      if (state !== savedState) {
        console.error('State inválido');
        return;
      }
      const verifier = localStorage.getItem('coze_verifier');
      if (!verifier) {
        console.error('code_verifier ausente');
        return;
      }

      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: CONFIG.clientId,
        code,
        redirect_uri: CONFIG.redirectUri,
        code_verifier: verifier
      });

      const resp = await fetch(CONFIG.tokenUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body
      });
      const tokenData = await resp.json();
      if (!tokenData.access_token) {
        console.error('Falha ao obter token:', tokenData);
        return;
      }
      localStorage.setItem('cozeAccessToken', tokenData.access_token);
      localStorage.setItem('tokenExpires', Date.now() + (tokenData.expires_in || 3600) * 1000);

      // limpar code/state da URL
      history.replaceState({}, document.title, CONFIG.redirectUri);
      // limpar temporários
      localStorage.removeItem('coze_state');
      localStorage.removeItem('coze_verifier');
    }

    function startChatIfReady() {
      const token = localStorage.getItem('cozeAccessToken');
      if (!token) {
        document.getElementById('login-btn').style.display = 'inline-block';
        return;
      }
      new CozeWebSDK.WebChatClient({
        config: { bot_id: CONFIG.botId },
        componentProps: { title: 'Assistente SEDAP' },
        auth: {
          type: 'token',
          token: token,
          onRefreshToken: async () => {
            // Estratégia simples para renovar: peça autorização novamente
            // await initiateOAuth();
            return localStorage.getItem('cozeAccessToken') || '';
          }
        },
        user: {
          id: getOrCreateUserId(),
          name: 'Visitante'
        }
      });
      document.getElementById('login-btn').style.display = 'none';
    }

    document.getElementById('login-btn').addEventListener('click', initiateOAuth);

    (async function init() {
      await exchangeCodeForTokenIfPresent();
      startChatIfReady();
    })();
  </script>
</body>
</html>
